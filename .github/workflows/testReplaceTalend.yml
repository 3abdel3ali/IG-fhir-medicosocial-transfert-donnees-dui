name: Run JAR on new ZIP in NOS

on:
  push:
    branches:
      - main
    paths:
      - "nos/*.json"
  pull_request:
    branches:
      - main
    paths:
      - "nos/*.json"

jobs:
  run-jar:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ R√©cup√©ration du d√©p√¥t
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Installation de Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3Ô∏è‚É£ Debug : afficher la structure du d√©p√¥t et s'assurer que le fichier de config existe
      - name: Debug - v√©rifier les fichiers et chemins
        run: |
          echo "R√©pertoire courant : $(pwd)"
          echo "Contenu de la racine :"
          ls -la
          echo "Contenu du dossier JAR :"
          ls -la JAR || true
          echo "Git index pour JAR/configuration.properties :"
          git ls-files -- JAR/configuration.properties || true

      - name: Configurer le fuseau horaire sur Paris
        run: |
          echo "üïí Configuration du fuseau horaire sur Europe/Paris"
          sudo ln -sf /usr/share/zoneinfo/Europe/Paris /etc/localtime
          date
      
      # 4Ô∏è‚É£ Ex√©cution du JAR depuis son propre r√©pertoire
      - name: Ex√©cuter le JAR depuis son r√©pertoire
        working-directory: JAR
        run: |
          echo "R√©pertoire courant : $(pwd)"
          echo "Contenu du dossier JAR :"
          ls -la

          # V√©rifier la pr√©sence du fichier de configuration
          if [ ! -f configuration.properties ]; then
            echo "‚ùå Fichier configuration.properties introuvable dans $(pwd)"
            exit 1
          fi

          # Cr√©er le r√©pertoire log (√† la racine du d√©p√¥t)
          mkdir -p ../log
          # Horodatage bas√© sur fuseau Europe/Paris
            TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
            LOG_FILE="../log/execution_${TIMESTAMP}.log"

          echo "üìù Le log sera enregistr√© sous : $LOG_FILE"

          # Ex√©cuter le JAR (le plus r√©cent dans JAR/)
          JAR_FILE=$(ls -t *.jar | head -n1)
          echo "üîß Ex√©cution de $JAR_FILE"
          # java -jar "$JAR_FILE" 2>&1 | tee ../log/execution.log
          java -jar "$JAR_FILE" > "$LOG_FILE" 2>&1

          # V√©rifier si le log a √©t√© g√©n√©r√©
          if [ -f "$LOG_FILE" ]; then
            echo "‚úÖ Log g√©n√©r√© : $LOG_FILE"
          else
            echo "‚ö†Ô∏è Aucun log trouv√© apr√®s l'ex√©cution du JAR"
          fi

          echo "üìÇ Contenu du dossier log :"
          ls -lh ../log
          
      # 5Ô∏è‚É£ Sauvegarde des logs comme artefacts
      - name: Sauvegarder les logs g√©n√©r√©s
        uses: actions/upload-artifact@v4
        with:
          name: jar-logs
          path: log/
