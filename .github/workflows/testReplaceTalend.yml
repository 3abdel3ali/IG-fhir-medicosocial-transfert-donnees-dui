name: Run JAR on new ZIP in NOS

on:
  push:
    branches:
      - main
    paths:
      - "nos/*.json"
  pull_request:
    branches:
      - main
    paths:
      - "nos/*.json"

jobs:
  run-jar:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ RÃ©cupÃ©ration du dÃ©pÃ´t
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Installation de Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3ï¸âƒ£ Debug : afficher la structure du dÃ©pÃ´t et s'assurer que le fichier de config existe
      - name: Debug - vÃ©rifier les fichiers et chemins
        run: |
          echo "RÃ©pertoire courant : $(pwd)"
          echo "Contenu de la racine :"
          ls -la
          echo "Contenu du dossier JAR :"
          ls -la JAR || true
          echo "Git index pour JAR/configuration.properties :"
          git ls-files -- JAR/configuration.properties || true

      # 4ï¸âƒ£ ExÃ©cution du JAR depuis son propre rÃ©pertoire
      - name: ExÃ©cuter le JAR depuis son rÃ©pertoire
        working-directory: JAR
        run: |
          echo "RÃ©pertoire courant : $(pwd)"
          echo "Contenu du dossier JAR :"
          ls -la

        # VÃ©rifier la prÃ©sence du fichier de configuration
          if [ ! -f configuration.properties ]; then
            echo "âŒ Fichier configuration.properties introuvable dans $(pwd)"
            exit 1
          fi

        # CrÃ©er le rÃ©pertoire log (Ã  la racine du dÃ©pÃ´t)
            mkdir -p ../log

        # Horodatage pour le fichier de log
             TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
             LOG_FILE="../log/execution_${TIMESTAMP}.log"

            echo "ðŸ“ Le log sera enregistrÃ© sous : $LOG_FILE"

        # ExÃ©cuter le JAR (le plus rÃ©cent dans JAR/)
           JAR_FILE=$(ls -t *.jar | head -n1)
           echo "ðŸ”§ ExÃ©cution de $JAR_FILE"
        #java -jar "$JAR_FILE" 2>&1 | tee ../log/execution.log
          java -jar "$JAR_FILE" > "$LOG_FILE" 2>&1

        # echo "ðŸ” Recherche du fichier de log gÃ©nÃ©rÃ© par le JAR..."
          # Trouver les fichiers .log gÃ©nÃ©rÃ©s pendant le run
          # find /home/runner -type f -name "*.log" 2>/dev/null | tee ../log/logs_found.txt

          # echo "ðŸ“‚ DÃ©placement des logs trouvÃ©s vers le dossier log/"
          # while IFS= read -r f; do
          # echo "DÃ©placement de $f vers ../log/"
          # cp "$f" ../log/ || true
          # done < ../log/logs_found.txt

          # echo "âœ… Logs dÃ©placÃ©s dans le dossier log/"
          # ls -lh ../log
         
         # VÃ©rifier si le log a Ã©tÃ© gÃ©nÃ©rÃ©
           if [ -f "$LOG_FILE" ]; then
            echo "âœ… Log gÃ©nÃ©rÃ© : $LOG_FILE"
           else
             echo "âš ï¸ Aucun log trouvÃ© aprÃ¨s l'exÃ©cution du JAR"
          fi

    echo "ðŸ“‚ Contenu du dossier log :"
    ls -lh ../log

      # 5ï¸âƒ£ Sauvegarde des logs comme artefacts
      - name: Sauvegarder les logs gÃ©nÃ©rÃ©s
        uses: actions/upload-artifact@v4
        with:
          name: jar-logs
          path: log/
